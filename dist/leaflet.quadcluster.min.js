L.QuadCluster={version:"0.0.1"},function(){function a(a,c,d,e){function f(a){if(!a.active)return a.mass=0,void(a.center=L.latLng(0,0));for(var b=0,c=0,d=0,e=0;4>e;e++)if(a.nodes[e]&&a.nodes[e].active){var f=a.nodes[e].center.lng,g=a.nodes[e].center.lat,h=a.nodes[e].mass,i=d/(d+h),j=h/(d+h);b=b*i+f*j,c=c*i+g*j,d+=h}a.point&&(b=b*(d/(d+1))+a.x/(d+1),c=c*(d/(d+1))+a.y/(d+1),d+=1),a.mass=d,a.center=L.latLng(c,b),a.active=d>0}function g(a){if(a=a||[],!this.active)return a;this.point&&a.push(this.point);for(var b=0;b<this.nodes.length;b++)this.nodes[b]&&this.nodes[b].getPoints(a);return a}function h(a,b,c,d,e,i){var j=.5*(c+e),k=.5*(d+i),l=a.nodes;a.depth=b,a.bounds=L.latLngBounds([[d,c],[i,e]]),a.id||(a.id=p++,a.active=!0),l[0]&&(h(l[0],b+1,c,d,j,k),l[0].parentID=a.id),l[1]&&(h(l[1],b+1,j,d,e,k),l[1].parentID=a.id),l[2]&&(h(l[2],b+1,c,k,j,i),l[2].parentID=a.id),l[3]&&(h(l[3],b+1,j,k,e,i),l[3].parentID=a.id),f(a),a.getPoints=g}var i=d3.geom.quadtree().x(c).y(d).extent(e),j=e[0][0],k=e[0][1],l=e[1][0],m=e[1][1],n=i(a),o={},p=1;return o.aggregate=function(a){var c=b(a,n,j,k,l,m);return null===c&&(c=a.initialize()),c},o.add=function(a){n.add(a),h(n,0,j,k,l,m)},o.addArray=function(a){for(var b=0;b<a.length;b++)n.add(a[b]);h(n,0,j,k,l,m)},o.root=function(){return n},o.clear=function(){return n=i([]),p=1,h(n,0,j,k,l,m),o},o.bounds=function(){var a=new L.LatLngBounds;return a.extend(n.bounds),a},o.filter=function(a){var b=L.QuadCluster.Aggregate().finalize(function(b,c){return c.active=a(c),f(c),b})();o.aggregate(b)},o.cut=function(a,b){a=L.latLngBounds(a);var c=L.QuadCluster.Aggregate().filter(function(c){if(!c.active)return!0;if(!a.intersects(c.bounds))return!0;if(!c.parentID)return!1;var d=Math.abs(c.bounds.getEast()-c.bounds.getWest());return b/2>d?!0:!1}).init(function(){return[]}).merge(function(a,b){return a.concat(b)}).finalize(function(a,b){return 0===a.length&&a.push(b),a})();return o.aggregate(c)},h(n,0,j,k,l,m),o}function b(a,c){var d=null,e,f=c.nodes;return a.filter(c)||(d=a.initialize(),d=a.accumulate(d,c),f[0]&&(e=b(a,f[0]),null!==e&&(d=a.merge(d,e,0))),f[1]&&(e=b(a,f[1]),null!==e&&(d=a.merge(d,e,1))),f[2]&&(e=b(a,f[2]),null!==e&&(d=a.merge(d,e,2))),f[3]&&(e=b(a,f[3]),null!==e&&(d=a.merge(d,e,3))),d=a.finalize(d,c)),d}L.QuadCluster.Tree=function(){function b(a){if(0===a.length)throw new Error("Must specify an extent if no points given during initialization");var b=[1/0,1/0],c=[-1/0,-1/0];return a.forEach(function(a){var f=d(a),g=e(a);b[0]=Math.min(f,b[0]),b[1]=Math.min(g,b[1]),c[0]=Math.max(f,c[0]),c[1]=Math.max(g,c[1])}),[b,c]}function c(a){var b=a[0][0],c=a[0][1],d=a[1][0],e=a[1][1],f=d-b,g=e-c;return f>g?e=c+f:d=b+g,[[b,c],[d,e]]}var d=function(a){return a.x},e=function(a){return a.y},f=null,g=function(g){var h=f;return h||(h=b(g)),h=c(h),a(g,d,e,h)};return g.x=function(a){return 0===arguments.length?d:(d=a,g)},g.y=function(a){return 0===arguments.length?e:(e=a,g)},g.extent=function(a){return 0===arguments.length?f:(f=a,g)},g}}(),function(){function a(a,b,c,d,e){this.initialize=a,this.filter=b,this.merge=c,this.accumulate=d,this.finalize=e}L.QuadCluster.Aggregate=function(){var b=function(){return{}},c=function(){return!1},d=function(a){return a},e=function(a){return a},f=function(a){return a},g=function(){return new a(b,c,e,d,f)};return g.init=function(a){return 0===arguments.length?b:(b=a,g)},g.filter=function(a){return 0===arguments.length?c:(c=a,g)},g.accumulate=function(a){return 0===arguments.length?d:(d=a,g)},g.merge=function(a){return 0===arguments.length?e:(e=a,g)},g.finalize=function(a){return 0===arguments.length?f:(f=a,g)},g}}(),L.QuadCluster.MarkerCluster=L.Marker.extend({initialize:function(a,b){L.Marker.prototype.initialize.call(this,b.center,{icon:this}),this._group=a,this._node=b,this._iconNeedsUpdate=!0},getAllChildMarkers:function(a){return a=a||[],node.getPoints(a),a},getChildCount:function(){return this._node.mass},zoomToBounds:function(){var a=this._group._map;a.fitBounds(this._node.bounds)},getBounds:function(){var a=new L.LatLngBounds;return a.extend(this._node.bounds),a},_updateIcon:function(){this._iconNeedsUpdate=!0,this._icon&&this.setIcon(this)},createIcon:function(){return this._iconNeedsUpdate&&(this._iconObj=this._group.options.iconCreateFunction(this),this._iconNeedsUpdate=!1),this._iconObj.createIcon()},createShadow:function(){return this._iconObj.createShadow()},spiderfy:function(){}}),L.QuadCluster.MarkerClusterGroup=L.FeatureGroup.extend({options:{maxClusterSize:160,clusterSizeScalingFactor:1.4,iconCreateFunction:null,zoomToBoundsOnClick:!0,spiderfyOnMaxZoom:!0},initialize:function(a,b){L.Util.setOptions(this,b),this.options.iconCreateFunction||(this.options.iconCreateFunction=this._defaultIconCreateFunction),this._featureGroup=L.featureGroup(),this._featureGroup.on(L.FeatureGroup.EVENTS,this._propagateEvent,this),this._nonPointGroup=L.featureGroup(),this._nonPointGroup.on(L.FeatureGroup.EVENTS,this._propagateEvent,this);var c=L.QuadCluster.Tree().x(function(a){return a.getLatLng().lng}).y(function(a){return a.getLatLng().lat});this._markers=a;for(var d=0;d<this._markers.length;d++)L.stamp(this._markers[d]);this._tree=c(a)},hasLayer:function(a){if(!a)return!1;for(var b=0;b<this._markers.length;b++)if(a===this._markers[b])return!0;return this._nonPointGroup.hasLayer(a)},addLayer:function(a){if(a instanceof L.LayerGroup){var b=[];for(var c in a._layers)b.push(a._layers[c]);return this.addLayers(b)}return a.getLatLng?this.hasLayer(a)?this:(L.stamp(a),this._markers.push(a),this._tree.add(a),this._refreshVisible(),this):(this._nonPointGroup.addLayer(a),this)},addLayers:function(a){for(var b=0;b<a.length;b++){var c=a[b];c.getLatLng?this.hasLayer(c)||(this._markers.push(c),this._tree.add(c)):this._nonPointGroup.addLayer(c)}return this._refreshVisible(),this},removeLayer:function(a){throw new Error("removeLayer not yet implemented.")},eachLayer:function(a,b){return this._featureGroup.eachLayer(a,b),this._nonPointGroup.eachLayer(a,b),this},getLayers:function(){var a=[];return this.eachLayer(function(b){a.push(b)}),a},getLayer:function(a){if(this._featureGroup.hasLayer(a))return this._featureGroup.getLayer(a);if(this._nonPointGroup.hasLayer(a))return this._nonPointGroup.getLayer(a);for(var b=0;b<this._markers.length;b++)if(L.stamp(this._markers[b])===a)return this._markers[b];return null},clearLayers:function(){return this._markers=[],this._tree.clear(),this._featureGroup.clearLayers(),this._nonPointGroup.clearLayers(),this},onAdd:function(a){this._map=a,this._refreshVisible(),this._featureGroup.onAdd(a),this._nonPointGroup.onAdd(a),this._map.on("zoomend",this._zoomEnd,this),this._map.on("moveend",this._moveEnd,this),(this.options.zoomToBoundsOnClick||this.options.spiderfyOnMaxZoom)&&this.on("clusterclick",this._zoomOrSpiderfy,this)},onRemove:function(a){a.off("zoomend",this._zoomEnd,this),a.off("moveend",this._moveEnd,this),this._featureGroup.onRemove(a),this._nonPointGroup.onRemove(a),this._map=null,(this.options.zoomToBoundsOnClick||this.options.spiderfyOnMaxZoom)&&this.off("clusterclick",this._zoomOrSpiderfy,this)},filter:function(a){this._tree.filter(a),this._refreshVisible()},getVisible:function(){return this._featureGroup.getLayers()},getVisibleMarkers:function(){var a=this.getVisible(),b=[];return a.forEach(function(a){a instanceof L.QuadTree.MarkerCluster||b.push(a)}),b},getVisibleClusters:function(){var a=this.getVisible(),b=[];return a.forEach(function(a){a instanceof L.QuadTree.MarkerCluster&&b.push(a)}),b},_getExpandedVisibleBounds:function(){var a=this._map,b=a.getBounds(),c=b.getSouthWest(),d=b.getNorthEast(),e=0,f=0;return L.latLngBounds(L.latLng(c.lat-e,c.lng-f),L.latLng(d.lat+e,d.lng+f))},_getClusterWidth:function(){var a=this._map,b=this.options.maxClusterSize,c=this.options.clusterSizeScalingFactor,d=a.getZoom();return b*c/Math.pow(2,d)},_refreshVisible:function(){if(this._map){for(var a=this._getExpandedVisibleBounds(),b=this._getClusterWidth(),c=this._tree.cut(a,b),d=[],e=0;e<c.length;e++){var f=c[e];1===f.mass?d.push(f.getPoints()[0]):(f.marker||(f.marker=this._createMarkerCluster(f)),f.marker._updateIcon(),d.push(f.marker))}this._featureGroup.clearLayers();for(var g=0;g<d.length;g++)this._featureGroup.addLayer(d[g]);this._currentCut=c,this.fire("refresh",d)}},_isOrIsParent:function(a,b){for(;b;){if(a===b)return!0;b=b.parentNode}return!1},_propagateEvent:function(a){if(a.layer instanceof L.QuadCluster.MarkerCluster){if(a.originalEvent&&this._isOrIsParent(a.layer._icon,a.originalEvent.relatedTarget))return;a.type="cluster"+a.type}this.fire(a.type,a)},_defaultIconCreateFunction:function(a){var b=a.getChildCount(),c="marker-cluster marker-cluster-";return c+=10>b?"small":100>b?"medium":"large",new L.DivIcon({html:"<div><span>"+b+"</span></div>",className:c,iconSize:new L.Point(40,40)})},_createMarkerCluster:function(a){var b=new L.QuadCluster.MarkerCluster(this,a);return L.stamp(b),b},_zoomEnd:function(){this._map&&this._refreshVisible()},_moveEnd:function(){this._refreshVisible()},_zoomOrSpiderfy:function(a){var b=this._map;b.getMaxZoom()==b.getZoom()?this.options.spiderfyOnMaxZoom&&a.layer.spiderfy():this.options.zoomToBoundsOnClick&&a.layer.zoomToBounds(),a.originalEvent&&13===a.originalEvent.keyCode&&b._container.focus()}}),L.QuadCluster.markerClusterGroup=function(a,b){return new L.QuadCluster.MarkerClusterGroup(a,b)};
//# sourceMappingURL=leaflet.quadcluster.min.map