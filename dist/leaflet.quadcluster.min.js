L.QuadCluster={version:"0.0.1"},function(){function a(a,b,c,d,e,f){this.bounds=b,this.parent=a,this.latAcc=c,this.lngAcc=d,this.epsilon=e,this.active=!0,this.leaf=!0,this.nodes=[],this.points=[],this.activePoints=[],f&&(this.points.push(f),this.activePoints.push(f),this.lat=c(f),this.lng=d(f)),this.computeGravityCenter()}function b(b,c,d,e,f){this.root=new a(null,b,c,d,e);for(var g=0;g<f.length;g++)this.root.add(f[g]);this.root.computeGravityCenter(!0)}function c(){function a(a){if(0===a.length)throw new Error("Must specify bounds of no points given for QuadTree initialization");var b=1/0,c=1/0,f=-1/0,g=-1/0,h,i,j,k;for(h=0;h<a.length;h++)i=a[h],j=d(i),k=e(i),b=Math.min(j,b),c=Math.min(k,c),f=Math.max(j,f),g=Math.max(k,g);return L.latLngBounds([b,c],[f,g])}function c(a){var b=a.getSouth(),c=a.getNorth(),d=a.getWest(),e=a.getEast(),f=c-b,g=e-d;return g>f?c=b+g:e=d+f,L.latLngBounds([b,d],[c,e])}var d=function(a){return a.lat},e=function(a){return a.lng},f=null,g=.1,h=function(h){var i=f;return i||(i=a(h)),i=c(i),new b(i,d,e,g,h)};return h.x=h.lng=function(a){return 0===arguments.length?e:(e=a,h)},h.y=h.lat=function(a){return 0===arguments.length?d:(d=a,h)},h.extent=h.bounds=function(a){return 0===arguments.length?f:(f=a,h)},h.epsilon=function(a){return 0===arguments.length?g:(g=a,h)},h}a.prototype.addToChild=function(b,c,d){var e=.5*(this.bounds.getSouth()+this.bounds.getNorth()),f=.5*(this.bounds.getWest()+this.bounds.getEast()),g,h,i,j,k=0;if(c>e?(k+=2,g=e,i=this.bounds.getNorth()):(g=this.bounds.getSouth(),i=e),d>f?(k+=1,h=f,j=this.bounds.getEast()):(h=this.bounds.getWest(),j=f),this.nodes[k])this.nodes[k].add(b);else{var l=L.latLngBounds([g,h],[i,j]);this.nodes[k]=new a(this,l,this.latAcc,this.lngAcc,this.epsilon,b)}},a.prototype.convertToInternal=function(){if(!this.leaf)throw new Error("Node is already internal");if(0===this.points.length)throw new Error("Converting node with no points to internal");this.leaf=!1;for(var a=0;a<this.points.length;a++)this.addToChild(this.points[a],this.lat,this.lng);return this.points=[],this.activePoints=[],this.lat=null,this.lng=null,this},a.prototype.add=function(a){var b=this.latAcc(a),c=this.lngAcc(a);if(!this.leaf)return this.addToChild(a,b,c),this;if(0===this.points.length)return this.points.push(a),this.activePoints.push(a),this.lat=b,this.lng=c,this;var d=Math.abs(this.lat-b),e=Math.abs(this.lng-c);return d<this.epsilon&&e<this.epsilon?(this.points.push(a),this.activePoints.push(a)):(this.convertToInternal(),this.addToChild(a,b,c)),this},a.prototype.computeGravityCenter=function(a){var b=0,c=0,d=0,e=0,f=0,g=0,h,i,j,k;if(this.leaf){for(j=0;j<this.activePoints.length;j++)d=this.latAcc(this.activePoints[j]),e=this.lngAcc(this.activePoints[j]),b+=d,c+=e,f+=1;b=f>0?b/f:0,c=f>0?c/f:0}else for(j=0;j<this.nodes.length;j++)this.nodes[j]&&(k=this.nodes[j],a&&k.computeGravityCenter(a),k.active&&(d=k.center.lat,e=k.center.lng,g=k.mass,h=f/(f+g),i=g/(f+g),b=b*h+d*i,c=c*h+e*i,f+=g));return this.center=L.latLng(b,c),this.mass=f,this.active=f>0,this},a.prototype.getPoints=function(a){if(a=a||[],!this.active)return a;if(this.leaf)for(var b=0;b<this.activePoints.length;b++)a.push(this.activePoints[b]);else for(var c=0;c<this.nodes.length;c++)this.nodes[c]&&this.nodes[c].active&&this.nodes[c].getPoints(a);return a},a.prototype.filter=function(a){if(this.leaf)this.activePoints=this.points.filter(a),this.computeGravityCenter(!1);else{for(var b=0;b<this.nodes.length;b++)this.nodes[b]&&this.nodes[b].filter(a);this.computeGravityCenter(!1)}},a.prototype.aggregate=function(a){var b=null,c,d=this.nodes;if(!a.filter(this)){b=a.initialize(),b=a.accumulate(b,this);for(var e=0;e<d.length;e++)d[e]&&(c=d[e].aggregate(a),null!==c&&(b=a.merge(b,c,e)));b=a.finalize(b,this)}return b},b.prototype.add=function(a){this.root.add(a),this.root.computeGravityCenter(!0)},b.prototype.filter=function(a){this.root.filter(a)},b.prototype.aggregate=function(a){var b=this.root.aggregate(a);return null===b&&(b=a.initialize()),b},b.prototype.cut=function(a,b){a=L.latLngBounds(a);var c=L.QuadCluster.Aggregate().filter(function(c){if(!c.active)return!0;if(!a.intersects(c.bounds))return!0;if(!c.parent)return!1;var d=Math.abs(c.bounds.getEast()-c.bounds.getWest());return b/2>d?!0:!1}).init(function(){return[]}).merge(function(a,b){for(var c=0;c<b.length;c++)a.push(b[c]);return a}).finalize(function(b,c){return 0===b.length&&a.contains(c.center)&&b.push(c),b})();return this.aggregate(c)},b.prototype.cutLeaves=function(a){a=L.latLngBounds(a);var b=L.QuadCluster.Aggregate().filter(function(b){return b.active&&a.intersects(b.bounds)?!1:!0}).init(function(){return[]}).merge(function(a,b){for(var c=0;c<b.length;c++)a.push(b[c]);return a}).finalize(function(a,b){return b.leaf&&a.push(b),a})();return this.aggregate(b)},L.QuadCluster.Tree=c}(),function(){function a(a,b,c,d,e){this.initialize=a,this.filter=b,this.merge=c,this.accumulate=d,this.finalize=e}L.QuadCluster.Aggregate=function(){var b=function(){return{}},c=function(){return!1},d=function(a){return a},e=function(a){return a},f=function(a){return a},g=function(){return new a(b,c,e,d,f)};return g.init=function(a){return 0===arguments.length?b:(b=a,g)},g.filter=function(a){return 0===arguments.length?c:(c=a,g)},g.accumulate=function(a){return 0===arguments.length?d:(d=a,g)},g.merge=function(a){return 0===arguments.length?e:(e=a,g)},g.finalize=function(a){return 0===arguments.length?f:(f=a,g)},g}}(),L.QuadCluster.MarkerCluster=L.Marker.extend({initialize:function(a,b){L.Marker.prototype.initialize.call(this,b.center,{icon:this}),this._group=a,this._node=b,this._iconNeedsUpdate=!0},getAllChildMarkers:function(a){return a=a||[],node.getPoints(a),a},getChildCount:function(){return this._node.mass},zoomToBounds:function(){var a=this._group._map;a.fitBounds(this._node.bounds)},getBounds:function(){var a=new L.LatLngBounds;return a.extend(this._node.bounds),a},_updateIcon:function(){this._iconNeedsUpdate=!0,this._icon&&this.setIcon(this)},createIcon:function(){return this._iconNeedsUpdate&&(this._iconObj=this._group.options.iconCreateFunction(this),this._iconNeedsUpdate=!1),this._iconObj.createIcon()},createShadow:function(){return this._iconObj.createShadow()},spiderfy:function(){}}),L.QuadCluster.MarkerClusterGroup=L.FeatureGroup.extend({options:{maxClusterSize:160,clusterSizeScalingFactor:1.4,iconCreateFunction:null,zoomToBoundsOnClick:!0,spiderfyOnMaxZoom:!0,singlesOnZoom:14,clusterEpsilon:.01},initialize:function(a,b){L.Util.setOptions(this,b),this.options.iconCreateFunction||(this.options.iconCreateFunction=this._defaultIconCreateFunction),this._featureGroup=L.featureGroup(),this._featureGroup.on(L.FeatureGroup.EVENTS,this._propagateEvent,this),this._nonPointGroup=L.featureGroup(),this._nonPointGroup.on(L.FeatureGroup.EVENTS,this._propagateEvent,this);var c=L.QuadCluster.Tree().lng(function(a){return a.getLatLng().lng}).lat(function(a){return a.getLatLng().lat}).epsilon(this.options.clusterEpsilon);this._markers=a;for(var d=0;d<this._markers.length;d++)L.stamp(this._markers[d]);this._tree=c(a)},hasLayer:function(a){if(!a)return!1;for(var b=0;b<this._markers.length;b++)if(a===this._markers[b])return!0;return this._nonPointGroup.hasLayer(a)},addLayer:function(a){if(a instanceof L.LayerGroup){var b=[];for(var c in a._layers)b.push(a._layers[c]);return this.addLayers(b)}return a.getLatLng?this.hasLayer(a)?this:(L.stamp(a),this._markers.push(a),this._tree.add(a),this._refreshVisible(),this):(this._nonPointGroup.addLayer(a),this)},addLayers:function(a){for(var b=0;b<a.length;b++){var c=a[b];c.getLatLng?this.hasLayer(c)||(this._markers.push(c),this._tree.add(c)):this._nonPointGroup.addLayer(c)}return this._refreshVisible(),this},removeLayer:function(a){throw new Error("removeLayer not yet implemented.")},eachLayer:function(a,b){return this._featureGroup.eachLayer(a,b),this._nonPointGroup.eachLayer(a,b),this},getLayers:function(){var a=[];return this.eachLayer(function(b){a.push(b)}),a},getLayer:function(a){if(this._featureGroup.hasLayer(a))return this._featureGroup.getLayer(a);if(this._nonPointGroup.hasLayer(a))return this._nonPointGroup.getLayer(a);for(var b=0;b<this._markers.length;b++)if(L.stamp(this._markers[b])===a)return this._markers[b];return null},clearLayers:function(){return this._markers=[],this._tree.clear(),this._featureGroup.clearLayers(),this._nonPointGroup.clearLayers(),this},onAdd:function(a){this._map=a,this._refreshVisible(),this._featureGroup.onAdd(a),this._nonPointGroup.onAdd(a),this._map.on("zoomend",this._zoomEnd,this),this._map.on("moveend",this._moveEnd,this),(this.options.zoomToBoundsOnClick||this.options.spiderfyOnMaxZoom)&&this.on("clusterclick",this._zoomOrSpiderfy,this)},onRemove:function(a){a.off("zoomend",this._zoomEnd,this),a.off("moveend",this._moveEnd,this),this._featureGroup.onRemove(a),this._nonPointGroup.onRemove(a),this._map=null,(this.options.zoomToBoundsOnClick||this.options.spiderfyOnMaxZoom)&&this.off("clusterclick",this._zoomOrSpiderfy,this)},filter:function(a){this._tree.filter(a),this._refreshVisible()},getVisible:function(){return this._featureGroup.getLayers()},getVisibleMarkers:function(){var a=this.getVisible(),b=[];return a.forEach(function(a){a instanceof L.QuadCluster.MarkerCluster||b.push(a)}),b},getVisibleClusters:function(){var a=this.getVisible(),b=[];return a.forEach(function(a){a instanceof L.QuadCluster.MarkerCluster&&b.push(a)}),b},_getExpandedVisibleBounds:function(){var a=this._map,b=a.getBounds(),c=b.getSouthWest(),d=b.getNorthEast(),e=0,f=0;return L.latLngBounds(L.latLng(c.lat-e,c.lng-f),L.latLng(d.lat+e,d.lng+f))},_getClusterWidth:function(){var a=this._map,b=this.options.maxClusterSize,c=this.options.clusterSizeScalingFactor,d=a.getZoom();return b*c/Math.pow(2,d)},_newLayersClustered:function(a,b){var c=this._tree.cut(a,b),d=[],e,f,g,h;for(e=0;e<c.length;e++)if(h=c[e],1===h.mass)for(g=h.getPoints(),f=0;f<g.length;f++)d.push(g[f]);else h.marker||(h.marker=this._createMarkerCluster(h)),h.marker._updateIcon(),d.push(h.marker);return this._currentCut=c,d},_newLayersSingles:function(a){var b=this._tree.cutLeaves(a);this._currentCut=b;for(var c=[],d=0;d<b.length;d++)for(var e=b[d].getPoints(),f=0;f<e.length;f++)a.contains(e[f].getLatLng())&&c.push(e[f]);return c},_refreshVisible:function(){if(this._map){var a=this._getExpandedVisibleBounds(),b=this._getClusterWidth(),c=this._map.getZoom(),d;for(d=c<this.options.singlesOnZoom?this._newLayersClustered(a,b):this._newLayersSingles(a),this._featureGroup.clearLayers(),j=0;j<d.length;j++)this._featureGroup.addLayer(d[j]);this.fire("refresh",d)}},_isOrIsParent:function(a,b){for(;b;){if(a===b)return!0;b=b.parentNode}return!1},_propagateEvent:function(a){if(a.layer instanceof L.QuadCluster.MarkerCluster){if(a.originalEvent&&this._isOrIsParent(a.layer._icon,a.originalEvent.relatedTarget))return;a.type="cluster"+a.type}this.fire(a.type,a)},_defaultIconCreateFunction:function(a){var b=a.getChildCount(),c="quadtree-cluster quadtree-cluster-";return c+=10>b?"small":100>b?"medium":"large",new L.DivIcon({html:"<div><span>"+b+"</span></div>",className:c,iconSize:new L.Point(40,40)})},_createMarkerCluster:function(a){var b=new L.QuadCluster.MarkerCluster(this,a);return L.stamp(b),b},_zoomEnd:function(){this._map&&this._refreshVisible()},_moveEnd:function(){this._refreshVisible()},_zoomOrSpiderfy:function(a){var b=this._map;b.getMaxZoom()==b.getZoom()?this.options.spiderfyOnMaxZoom&&a.layer.spiderfy():this.options.zoomToBoundsOnClick&&a.layer.zoomToBounds(),a.originalEvent&&13===a.originalEvent.keyCode&&b._container.focus()}}),L.QuadCluster.markerClusterGroup=function(a,b){return new L.QuadCluster.MarkerClusterGroup(a,b)};
//# sourceMappingURL=leaflet.quadcluster.min.map